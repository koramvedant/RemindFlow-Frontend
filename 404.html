// server.js
const express = require('express');
require('dotenv').config();
const cors = require('cors');
const helmet = require('helmet');
const cookieParser = require('cookie-parser');
const path = require('path');

// DB
const { testDB } = require('./config/db');

// Routes
const authRoutes = require('./routes/authRoutes');
const reminderRoutes = require('./routes/reminderRoutes');
const invoiceRoutes = require('./routes/invoiceRoutes');
const paymentRoutes = require('./routes/paymentRoutes');
const webhookRoutes = require('./routes/webhookRoutes');
const settingsRoutes = require('./routes/settings');
const userRoutes = require('./routes/userRoutes');
const dashboardRoutes = require('./routes/dashboardRoutes');

// Middleware
const { authMiddleware } = require('./middleware/authMiddleware');
const rateLimiter = require('./middleware/rateLimit');

// -----------------------
// App init
// -----------------------
const app = express();
app.set('trust proxy', 1);

// -----------------------
// View engine
// -----------------------
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// -----------------------
// Static files
// -----------------------
app.use(express.static(path.join(__dirname, 'public')));
app.use('/js', express.static(path.join(__dirname, 'public/js')));

// -----------------------
// Core middleware
// -----------------------
app.use(cookieParser());

app.use(
  helmet({
    crossOriginEmbedderPolicy: false,
    contentSecurityPolicy: {
      useDefaults: false,
      directives: {
        defaultSrc: ["'self'"],

        scriptSrc: [
          "'self'",
          "'unsafe-inline'",
          "'unsafe-eval'",
          "https://www.gstatic.com",
          "https://www.gstatic.com/firebasejs",
          "https://apis.google.com",
          "https://accounts.google.com",
          "https://www.googleapis.com",
          "https://checkout.razorpay.com",
        ],

        connectSrc: [
          "'self'",
          "https://www.gstatic.com", // ðŸ”¥ Firebase source maps & internals
          "https://identitytoolkit.googleapis.com",
          "https://securetoken.googleapis.com",
          "https://apis.google.com",
          "https://www.googleapis.com",
          "https://api.razorpay.com",
        ],

        frameSrc: [
          "'self'",
          "https://accounts.google.com",
          "https://checkout.razorpay.com",
          "https://remindflow.in", // ðŸ”¥ REQUIRED for Google OAuth iframe
          "https://www.remindflow.in",
          "https://remindflow-backend.onrender.com",
        ],

        imgSrc: [
          "'self'",
          "data:",
          "https://www.gstatic.com",
          "https://img.icons8.com",
        ],

        styleSrc: [
          "'self'",
          "'unsafe-inline'",
        ],
      },
    },
  })
);

app.use(express.json({ limit: '10kb' }));
app.use(express.urlencoded({ extended: true }));

// -----------------------
// CORS
// -----------------------
app.use(
  cors({
    origin: [
      'https://remindflow.in',
      'https://www.remindflow.in',
      'http://localhost:3000',
      'http://localhost:5173',
    ],
    credentials: true,
  })
);

// =====================================================
// ROUTES
// =====================================================

app.get('/', (req, res) => res.redirect('https://remindflow.in'));

app.use('/api/auth', rateLimiter);
app.use('/api/auth', authRoutes);

app.use('/api/user', authMiddleware, userRoutes);
app.use('/api/dashboard', authMiddleware, dashboardRoutes);
app.use('/api/reminders', authMiddleware, reminderRoutes);
app.use('/api/invoices', authMiddleware, invoiceRoutes);
app.use('/api/settings', authMiddleware, settingsRoutes);

app.use(
  '/api/payments',
  authMiddleware,
  (req, res, next) => {
    if (!process.env.RAZORPAY_KEY_ID) {
      return res.status(503).json({ success: false });
    }
    next();
  },
  paymentRoutes
);

// Webhooks
app.use('/api/webhooks/razorpay', express.raw({ type: '*/*' }));
app.use('/api/webhooks', webhookRoutes);

// =====================================================
// VIEW ROUTES
// =====================================================

app.get('/login', (req, res) => {
  res.render('login');
});

app.get('/verify', authMiddleware, (req, res) => {
  if (req.user.verified) return res.redirect('/plans');
  res.render('verify', { user: req.user });
});

app.get('/plans', authMiddleware, (req, res) => {
  if (!req.user.verified) return res.redirect('/verify');
  res.render('plans', { user: req.user });
});

app.get('/dashboard', authMiddleware, (req, res) => {
  res.render('dashboard', { user: req.user });
});

// =====================================================
// 404
// =====================================================
app.use((req, res) => {
  res.status(404).render('404');
});

// =====================================================
// Error handler
// =====================================================
app.use((err, req, res, next) => {
  console.error('âŒ Server Error:', err);
  res.status(500).json({ success: false });
});

// =====================================================
// Start server
// =====================================================
const PORT = process.env.PORT || 7000;
app.listen(PORT, async () => {
  await testDB();
  console.log(`ðŸš€ Server running on ${PORT}`);
});
